let db;function getWeek(e=0){let o=new Date;dowOffset=new Date(o.getDay(),0,0),dowOffset="number"==typeof dowOffset?dowOffset:0;var t=new Date(o.getFullYear(),0,1),s=t.getDay()-dowOffset;s=s>=0?s:s+7;var n,a=Math.floor((o.getTime()-t.getTime()-6e4*(o.getTimezoneOffset()-t.getTimezoneOffset()))/864e5)+1;s<4?(n=Math.floor((a+s-1)/7)+1)>52&&(nYear=new Date(o.getFullYear()+1,0,1),nday=nYear.getDay()-dowOffset,nday=nday>=0?nday:nday+7,n=nday<4?1:53):n=Math.floor((a+s-1)/7);let i=n+e,r=(new Date).getFullYear();return i<=0&&(i=52+i,r-=1),"W"+i+"Y"+r}function localStorage_consomationtotal(e){null==(o=localStorage.getItem("consomationtotal"))&&(console.log("Creation de consomationtotal en localStorage"),localStorage.setItem("consomationtotal",0));var o=localStorage.getItem("consomationtotal");return localStorage.setItem("consomationtotal",parseInt(o)+parseInt(e)),o}function remove_localStorage_consomationtotal(){localStorage.removeItem("consomationtotal")}async function GetSite(e){return new Promise((o,t)=>{var s=db.transaction(["suivi_conso"],"readwrite").objectStore("suivi_conso").index("semaine").get(getWeek(e));s.onsuccess=async function(){let e;try{e=s.result.site}catch(o){e=[]}o(e)}})}function start(e,o){sites0=e[0],sites1=e[-1];var t=0,s={Streaming:0,Mails:0,Recherches:0,Reseaux_Sociaux:0,Autres:0,Cloud:0,E_commerce:0},n={Streaming:0,Mails:0,Recherches:0,Reseaux_Sociaux:0,Autres:0,Cloud:0,E_commerce:0};for(let e in sites0){let t=0;for(categorie in o)-1!=o[categorie].indexOf(e)?s[categorie]+=Math.round(sites0[e]):t++,6==t&&(s.Autres+=Math.round(sites0[e]))}for(let e in sites1){let t=0;for(categorie in o)-1!=o[categorie].indexOf(e)?n[categorie]+=Math.round(sites1[e]):t++,6==t&&(n.Autres+=Math.round(sites1[e]))}virtuosite={Mails:2835e3,Streaming:931e7,Recherches:81e5,Reseaux_Sociaux:49e7,Autres:112e7},s.Autres=s.Autres+s.E_commerce+s.Cloud,s.E_commerce=s.Cloud=0,n.Autres=n.Autres+n.E_commerce+n.Cloud,n.E_commerce=n.Cloud=0;var a=1-(new Date).getDay()/7;for(var i in virtuosite)if(conso7=s[i]+n[i]*a,conso7<virtuosite[i])t+=20;else{let e=virtuosite[i]/10,o=(conso7-virtuosite[i])/e;o>20&&(o=20),t+=20-o}t=Math.round(t),localStorage.setItem("Score",t)}var callback=function(e){var o=e.responseHeaders;let t=e.initiator;try{let e=new URL(t);hosturl=e.host,modenormal=localStorage.getItem("profunStorage");for(const e of o)if(length=e.name,"content-length"==length&&"false"!=modenormal&&(localStorage_consomationtotal(e.value),autoData({semaine:getWeek(),consomation:parseInt(e.value),site:{}}),e.value>0)){for(var s=[],n=0;n<hosturl.length;n++)"."==hosturl[n]&&s.push(n);let o=s[s.length-1];if(s.length>1){let e=s[s.length-2];if(-1==["mail","outlook","web-mail","messageriepro3","drive","cloud","photos","live","music","webmail"].indexOf(hosturl.substring(0,e)))var a=hosturl.substring(e+1,o);else a=hosturl.substring(0,o)}else{a=hosturl.substring(o,0);caschiant=[],motcledecaschiant=[]}updateSites(getWeek(),a,parseInt(e.value))}}catch(e){}},filter={urls:["<all_urls>"]},opt_extraInfoSpec=["responseHeaders"];chrome.webRequest.onHeadersReceived.addListener(callback,filter,opt_extraInfoSpec);let request=window.indexedDB.open("suivi_conso",1);function addData(e){let o=db.transaction(["suivi_conso"],"readwrite");o.objectStore("suivi_conso").add(e);o.oncomplete=function(){console.log("Transaction completed: database modification finished.")},o.onerror=function(){console.log("Transaction not opened due to error")}}function displayData(e){db.transaction("suivi_conso").objectStore("suivi_conso").openCursor().onsuccess=function(e){let o=e.target.result;o?(sem=o.value.semaine,con=o.value.consomation,sit=o.value.site,console.log("@---@"),console.log(sem),console.log(con),console.log(sit),console.log("@-^-@"),o.continue()):console.log("Pas d autre données dans la BDD")}}function deleteItembyid(e){db.transaction(["suivi_conso"],"readwrite").objectStore("suivi_conso").delete(e).onsuccess=function(o){console.log("Entrée surpprimée avec succès !"),console.log("Suivi_conso "+e+" deleted.")}}function deleteItem(e){var o=db.transaction(["suivi_conso"],"readwrite").objectStore("suivi_conso").index("semaine").get(e);o.onsuccess=function(){deleteItembyid(o.result.id)}}function updateData(e){sem=e.semaine,conso=e.consomation,sites=e.site;var o=db.transaction(["suivi_conso"],"readwrite").objectStore("suivi_conso"),t=o.index("semaine").get(sem);t.onsuccess=function(){var e=t.result;e.consomation=e.consomation+conso,e.site=Object.assign({},e.site,sites),o.put(e).onsuccess=function(){}}}function autoData(e){var o=e.semaine,t=db.transaction(["suivi_conso"],"readwrite").objectStore("suivi_conso").index("semaine").get(o);t.onsuccess=function(){null!=t.result?updateData(e):addData(e)}}function updateSites(e,o,t){var s=db.transaction(["suivi_conso"],"readwrite").objectStore("suivi_conso").index("semaine").get(e);s.onsuccess=function(){try{var n=s.result.site;null!=n[o]?n[o]=n[o]+t:n[o]=t,autoData({semaine:e,consomation:0,site:n})}catch(e){}}}function deleteBDD(){var e=window.indexedDB.deleteDatabase("suivi_conso");e.onerror=function(e){console.log("Erreur lors de la suppression de la base")},e.onsuccess=function(e){console.log("BDD suivi_conso was kill by you !"),console.log(e.result)}}function deleteAllDATA(){deleteBDD(),remove_localStorage_consomationtotal()}request.onerror=function(){console.log("Database failed to open")},request.onsuccess=function(){console.log("Database opened successfully"),db=request.result,thelistesite=Promise.all([GetSite(0),GetSite(-1)]).then(e=>{sites=e,fetch("/../bdd_sites.json").then(e=>e.json()).then(e=>start(sites,e))})},request.onupgradeneeded=function(e){let o=e.target.result.createObjectStore("suivi_conso",{keyPath:"id",autoIncrement:!0});o.createIndex("semaine","semaine",{unique:!0}),o.createIndex("consomation","consomation",{unique:!1}),o.createIndex("site","site",{unique:!1}),console.log("Database setup complete")};